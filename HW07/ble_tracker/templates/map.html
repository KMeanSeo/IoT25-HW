<!DOCTYPE html>
<html>
<head>
    <title>Real-time BLE Tracker</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <svg id="map" width="800" height="600"></svg>

    <script>
        const svg = d3.select("#map");
        const simulation = d3.forceSimulation()
            .force("charge", d3.forceManyBody().strength(-50))
            .force("center", d3.forceCenter(400, 300));

        const evtSource = new EventSource("/stream");
        
        evtSource.onmessage = (e) => {
            const data = JSON.parse(e.data);
            updateMap(data.data);
        };

        function updateMap(nodeData) {
            const nodes = [ 
                {id: "Anchor", x: 400, y: 300, fixed: true},  // 서버 위치 고정
                ...Object.values(nodeData).map(d => ({
                    id: d.id,
                    x: d.x * 100 + 400,
                    y: d.y * 100 + 300
                }))
            ];

            // 노드 업데이트
            const circles = svg.selectAll("circle")
                .data(nodes, d => d.id);
            
            circles.enter()
                .append("circle")
                .attr("r", 10)
                .merge(circles)
                .attr("cx", d => d.x)
                .attr("cy", d => d.y)
                .attr("fill", d => d.id === "Anchor" ? "red" : "blue");

            // 연결선 업데이트
            const links = svg.selectAll("line")
                .data(nodes.filter(d => d.id !== "Anchor"));
            
            links.enter()
                .append("line")
                .merge(links)
                .attr("x1", 400)
                .attr("y1", 300)
                .attr("x2", d => d.x)
                .attr("y2", d => d.y)
                .attr("stroke", "#999");
        }
    </script>
</body>
</html>
